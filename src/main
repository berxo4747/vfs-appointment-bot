# src/main.py

from playwright.sync_api import sync_playwright
from config_loader import load_settings
from login import login
from captcha_solver import solve_image_captcha
from appointment_checker import check_available_slots
from reservation import reserve_slot
from notifier import send_telegram_message, send_email

settings = load_settings()

def run_bot():
    with sync_playwright() as p:
        browser = p.chromium.launch(headless=False)
        page = browser.new_page()

        try:
            # GiriÅŸ
            login(page)

            # CAPTCHA Ã§Ã¶zÃ¼mÃ¼ gerekiyorsa
            if settings["vfs"]["captcha"]["type"] == "image":
                captcha_element = page.locator("img.captcha-image")
                captcha_element.screenshot(path="captcha.png")
                captcha_text = solve_image_captcha("captcha.png")
                page.fill('input[name="captcha"]', captcha_text)
                page.click(settings["vfs"]["login"]["submit_button"])
                page.wait_for_load_state("networkidle")

            # Randevu slotlarÄ±nÄ± kontrol et
            slots = check_available_slots(page)

            if slots:
                # Ä°lk uygun slot iÃ§in rezervasyon dene
                success = reserve_slot(page, slots[0])
                if success:
                    send_telegram_message(f"âœ… Randevu alÄ±ndÄ±: {slots[0]}")
                    send_email("Randevu OnayÄ±", f"Randevunuz baÅŸarÄ±yla alÄ±ndÄ±: {slots[0]}")
                else:
                    send_telegram_message("âš ï¸ Randevu denemesi baÅŸarÄ±sÄ±z.")
            else:
                send_telegram_message("ğŸ” Uygun randevu bulunamadÄ±.")
        except Exception as e:
            print(f"[ERROR] Bot Ã§alÄ±ÅŸÄ±rken hata oluÅŸtu: {e}")
            send_telegram_message(f"âŒ Bot hatasÄ±: {e}")
        finally:
            browser.close()

if __name__ == "__main__":
    run_bot()
